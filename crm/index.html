<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clover ERA CRM - Dashboard</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="/images/clover-favicon.svg">

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <style>
        :root {
            --primary-green: #10b981;
            --dark-green: #059669;
            --light-green: #d1fae5;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --background: #f9fafb;
            --medium-gray: #e5e7eb;
            --border-color: #d1d5db;
            --danger-red: #EF4444;
            --warning-orange: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--light-gray);
        }

        .nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: var(--primary-green);
        }

        .nav-links a.active {
            color: var(--primary-green);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            color: var(--text-primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-green);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--background);
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: var(--medium-gray);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-logout:hover {
            background: var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .metric-card .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-green);
        }

        .metric-card .change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .change.positive {
            color: var(--success-green);
        }

        .change.negative {
            color: var(--danger-red);
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .section-header h2 {
            font-size: 1.3rem;
            color: var(--charcoal);
        }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .pipeline-stage {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 1rem;
            min-height: 300px;
        }

        .pipeline-stage-header {
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-count {
            background: var(--primary-green);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .opportunity-card {
            background: #f0fdf4;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-green);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .opportunity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .opportunity-card .title {
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .opportunity-card .company {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .opportunity-card .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success-green);
            margin-top: 0.5rem;
        }

        .opportunity-card .meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.75rem;
            background: var(--light-gray);
            color: var(--charcoal);
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        tr:hover {
            background: var(--light-gray);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-lead { background: #E0F2FE; color: #0369A1; }
        .badge-qualified { background: #DBEAFE; color: #1E40AF; }
        .badge-demo { background: #E0E7FF; color: #4338CA; }
        .badge-proposal { background: #F3E8FF; color: #7C3AED; }
        .badge-negotiation { background: #FEF3C7; color: #D97706; }
        .badge-pilot { background: #FED7AA; color: #C2410C; }
        .badge-won { background: #D1FAE5; color: #047857; }
        .badge-lost { background: #FEE2E2; color: #DC2626; }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            color: var(--charcoal);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .pipeline {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 2px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.75rem;
            color: var(--charcoal);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: var(--medium-gray);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--charcoal);
        }

        .form-group label .required {
            color: var(--danger-red);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .form-group .hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            font-size: 1.25rem;
            color: var(--charcoal);
            margin-bottom: 1rem;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid var(--medium-gray);
        }

        .btn-large {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }

        .add-new-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--primary-green);
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }

        .add-new-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 0;
            }

            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">Clover ERA CRM</div>
        <div class="nav-links">
            <a href="index.html" class="active">Dashboard</a>
            <a href="companies.html">Companies</a>
            <a href="activities.html">Activities</a>
            <a href="kanban.html">Kanban</a>
            <a href="blog-articles.html">üìù Blog</a>
            <a href="admin.html" id="adminLink" style="display: none;">Admin</a>
            <span id="userInfo" style="color: var(--text-secondary);"></span>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Page Header -->
        <div class="header">
            <h1>Sales Dashboard</h1>
            <button class="btn btn-primary" onclick="showNewOpportunityModal()">+ New Opportunity</button>
        </div>

        <!-- View Filter -->
        <div style="background: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <label style="font-weight: 600; margin-right: 1rem;">View:</label>
                <select id="viewFilter" onchange="changeView()" style="padding: 0.5rem 1rem; border: 2px solid var(--medium-gray); border-radius: 8px; font-size: 1rem;">
                    <option value="my">My Opportunities</option>
                    <option value="all">All Team Opportunities</option>
                </select>
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                <span id="currentUserDisplay"></span>
            </div>
        </div>

        <!-- Today's Tasks -->
        <div class="section" style="margin-bottom: 2rem;">
            <div class="section-header">
                <h2>üìã What Needs to Be Done Today</h2>
            </div>
            <div id="todaysTasks" style="background: white; border-radius: 12px; padding: 1.5rem;">
                <div id="tasksLoading" class="loading">Loading today's tasks...</div>
                <div id="tasksContent" style="display: none;">
                    <div id="overdueTasksList" style="margin-bottom: 1.5rem;"></div>
                    <div id="dueTodayList" style="margin-bottom: 1.5rem;"></div>
                    <div id="followUpsList"></div>
                </div>
                <div id="noTasks" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
                    üéâ All caught up! No tasks due today.
                </div>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="label">Total Pipeline Value</div>
                <div class="value" id="totalPipelineValue">$0</div>
                <div class="change positive">Loading...</div>
            </div>

            <div class="metric-card">
                <div class="label">Open Opportunities</div>
                <div class="value" id="openOpportunities">0</div>
                <div class="change">Loading...</div>
            </div>

            <div class="metric-card">
                <div class="label">Weighted Pipeline</div>
                <div class="value" id="weightedPipeline">$0</div>
                <div class="change">Probability-adjusted</div>
            </div>

            <div class="metric-card">
                <div class="label">Win Rate</div>
                <div class="value" id="winRate">0%</div>
                <div class="change">Last 90 days</div>
            </div>
        </div>

        <!-- Sales Pipeline -->
        <div class="section">
            <div class="section-header">
                <h2>Sales Pipeline</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" id="viewToggleBtn" onclick="togglePipelineView()">
                        <span id="viewToggleText">View by Company</span>
                    </button>
                    <button class="btn btn-secondary" onclick="refreshPipeline()">Refresh</button>
                </div>
            </div>

            <div id="pipelineLoading" class="loading">
                <p>Loading pipeline...</p>
            </div>

            <!-- Opportunity-based Pipeline (default) -->
            <div id="pipelineContainer" class="pipeline" style="display: none;">
                <!-- Pipeline stages will be dynamically populated -->
            </div>

            <!-- Company-based Pipeline -->
            <div id="companyPipelineContainer" class="pipeline" style="display: none;">
                <!-- Company pipeline stages will be dynamically populated -->
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="section">
            <div class="section-header">
                <h2>Recent Activities</h2>
                <a href="/crm/activities.html" class="btn btn-secondary">View All</a>
            </div>

            <div id="activitiesLoading" class="loading">
                <p>Loading activities...</p>
            </div>

            <div id="activitiesContainer" class="table-container" style="display: none;">
                <table id="activitiesTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Company</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesTableBody">
                        <!-- Activities will be dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- New Opportunity Modal -->
    <div id="newOpportunityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Opportunity</h2>
                <button class="modal-close" onclick="closeNewOpportunityModal()">&times;</button>
            </div>

            <form id="newOpportunityForm" onsubmit="saveNewOpportunity(event)">
                <div class="modal-body">
                    <!-- Company & Contact Section -->
                    <div class="form-section">
                        <h3>Company & Contact</h3>

                        <div class="form-group">
                            <label for="oppCompany">Company <span class="required">*</span></label>
                            <select id="oppCompany" required onchange="loadCompanyContacts()">
                                <option value="">Select a company...</option>
                            </select>
                            <a class="add-new-link" onclick="showAddCompanyForm()">+ Add New Company</a>
                        </div>

                        <!-- Quick Add Company Form (hidden by default) -->
                        <div id="addCompanyForm" style="display: none; background: var(--light-gray); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newCompanyName">Company Name</label>
                                    <input type="text" id="newCompanyName">
                                </div>
                                <div class="form-group">
                                    <label for="newCompanyIndustry">Industry</label>
                                    <input type="text" id="newCompanyIndustry">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newCompanyType">Company Type</label>
                                <select id="newCompanyType">
                                    <option value="customer">Customer (Potential/Existing Customer)</option>
                                    <option value="partner">Partner (Reseller/Channel Partner)</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveNewCompany()">Save Company</button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddCompanyForm()">Cancel</button>
                        </div>

                        <div class="form-group">
                            <label for="oppContact">Primary Contact</label>
                            <select id="oppContact">
                                <option value="">Select a contact...</option>
                            </select>
                            <a class="add-new-link" onclick="showAddContactForm()">+ Add New Contact</a>
                        </div>

                        <!-- Quick Add Contact Form (hidden by default) -->
                        <div id="addContactForm" style="display: none; background: var(--light-gray); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newContactFirstName">First Name</label>
                                    <input type="text" id="newContactFirstName">
                                </div>
                                <div class="form-group">
                                    <label for="newContactLastName">Last Name</label>
                                    <input type="text" id="newContactLastName">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newContactEmail">Email</label>
                                    <input type="email" id="newContactEmail">
                                </div>
                                <div class="form-group">
                                    <label for="newContactTitle">Title</label>
                                    <input type="text" id="newContactTitle">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveNewContact()">Save Contact</button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddContactForm()">Cancel</button>
                        </div>
                    </div>

                    <!-- Opportunity Details Section -->
                    <div class="form-section">
                        <h3>Opportunity Details</h3>

                        <div class="form-group">
                            <label for="oppTitle">Opportunity Title <span class="required">*</span></label>
                            <input type="text" id="oppTitle" required placeholder="e.g., Manager Enablement Pilot">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oppStage">Stage <span class="required">*</span></label>
                                <select id="oppStage" required>
                                    <option value="lead">Lead</option>
                                    <option value="qualified">Qualified</option>
                                    <option value="demo-scheduled">Demo Scheduled</option>
                                    <option value="demo-completed">Demo Completed</option>
                                    <option value="proposal">Proposal</option>
                                    <option value="negotiation">Negotiation</option>
                                    <option value="pilot">Pilot</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="oppProbability">Probability (%)</label>
                                <input type="number" id="oppProbability" min="0" max="100" value="10">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oppSource">Source</label>
                                <select id="oppSource">
                                    <option value="inbound">Inbound</option>
                                    <option value="outbound">Outbound</option>
                                    <option value="partner">Partner</option>
                                    <option value="referral">Referral</option>
                                    <option value="event">Event</option>
                                    <option value="website">Website</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="oppCloseDate">Expected Close Date</label>
                                <input type="date" id="oppCloseDate">
                            </div>
                        </div>
                    </div>

                    <!-- Financials Section -->
                    <div class="form-section">
                        <h3>Financials</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oppManagers">Manager Count <span class="required">*</span></label>
                                <input type="number" id="oppManagers" required min="1" value="1" onchange="calculateFinancials()">
                                <div class="hint">Number of manager licenses</div>
                            </div>
                            <div class="form-group">
                                <label for="oppPricePerManager">Price per Manager/Month</label>
                                <input type="number" id="oppPricePerManager" value="295" onchange="calculateFinancials()">
                                <div class="hint">Default: $295/manager/month</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oppMRR">Monthly Recurring Revenue (MRR)</label>
                                <input type="number" id="oppMRR" readonly style="background: var(--light-gray);">
                                <div class="hint">Auto-calculated: Managers √ó Price</div>
                            </div>
                            <div class="form-group">
                                <label for="oppACV">Annual Contract Value (ACV)</label>
                                <input type="number" id="oppACV" readonly style="background: var(--light-gray);">
                                <div class="hint">Auto-calculated: MRR √ó 12</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="oppEmployees">Employees Covered</label>
                            <input type="number" id="oppEmployees" min="0">
                            <div class="hint">Total employees that will use the platform</div>
                        </div>
                    </div>

                    <!-- Additional Info Section -->
                    <div class="form-section">
                        <h3>Additional Information</h3>

                        <div class="form-group">
                            <label for="oppNextStep">Next Step</label>
                            <input type="text" id="oppNextStep" placeholder="e.g., Schedule demo call">
                        </div>

                        <div class="form-group">
                            <label for="oppNotes">Notes</label>
                            <textarea id="oppNotes" rows="4" placeholder="Internal notes about this opportunity..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-large" onclick="closeNewOpportunityModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-large">Create Opportunity</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://drugebiitlcjkknjfxeh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydWdlYmlpdGxjamtrbmpmeGVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjY1MDQsImV4cCI6MjA3ODM0MjUwNH0.HaYY0UxEC4cYyC3V4O0RyIkm7JTljnQapUnaeBoXba8';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUserId = null;
        let currentUserEmail = null;
        let currentView = 'my'; // 'my' or 'all'

        // Stage definitions
        const STAGES = {
            'lead': { name: 'Lead', order: 1 },
            'qualified': { name: 'Qualified', order: 2 },
            'demo-scheduled': { name: 'Demo Scheduled', order: 3 },
            'demo-completed': { name: 'Demo Completed', order: 4 },
            'proposal': { name: 'Proposal', order: 5 },
            'negotiation': { name: 'Negotiation', order: 6 },
            'pilot': { name: 'Pilot', order: 7 },
            'closed-won': { name: 'Closed Won', order: 8 },
            'closed-lost': { name: 'Closed Lost', order: 9 }
        };

        // Format currency
        function formatCurrency(amount) {
            if (!amount) return '$0';
            return '$' + amount.toLocaleString();
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Check authentication on page load
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = '/crm/login.html';
                return false;
            }

            currentUserId = session.user.id;
            currentUserEmail = session.user.email;

            document.getElementById('userInfo').textContent = session.user.email;
            document.getElementById('currentUserDisplay').textContent = `Logged in as: ${session.user.email}`;

            // Check if user is admin and show admin link
            const { data: profile } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (profile && profile.role === 'admin') {
                document.getElementById('adminLink').style.display = 'inline-block';
            }

            return true;
        }

        // Change view between my opportunities and all opportunities
        async function changeView() {
            currentView = document.getElementById('viewFilter').value;
            await Promise.all([
                loadMetrics(),
                loadPipeline(),
                loadActivities()
            ]);
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = '/crm/login.html';
        }

        // Load metrics
        async function loadMetrics() {
            try {
                // Get all open opportunities (filtered by view)
                let query = supabase
                    .from('opportunities')
                    .select('*')
                    .not('stage', 'in', '("closed-won","closed-lost")');

                // Filter by owner if viewing "my" opportunities
                if (currentView === 'my' && currentUserId) {
                    query = query.eq('owner_id', currentUserId);
                }

                const { data: opportunities, error } = await query;

                if (error) throw error;

                // Calculate total pipeline value
                const totalValue = opportunities.reduce((sum, opp) => sum + (opp.value || 0), 0);
                document.getElementById('totalPipelineValue').textContent = formatCurrency(totalValue);

                // Count open opportunities
                document.getElementById('openOpportunities').textContent = opportunities.length;

                // Calculate weighted pipeline
                const weightedValue = opportunities.reduce((sum, opp) => {
                    return sum + ((opp.value || 0) * (opp.probability || 0) / 100);
                }, 0);
                document.getElementById('weightedPipeline').textContent = formatCurrency(Math.round(weightedValue));

                // Calculate win rate (last 90 days)
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

                let closedQuery = supabase
                    .from('opportunities')
                    .select('stage')
                    .gte('updated_at', ninetyDaysAgo.toISOString())
                    .in('stage', ['closed-won', 'closed-lost']);

                if (currentView === 'my' && currentUserId) {
                    closedQuery = closedQuery.eq('owner_id', currentUserId);
                }

                const { data: closedOpps } = await closedQuery;

                const won = closedOpps?.filter(o => o.stage === 'closed-won').length || 0;
                const total = closedOpps?.length || 0;
                const winRate = total > 0 ? Math.round((won / total) * 100) : 0;
                document.getElementById('winRate').textContent = winRate + '%';

            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Load pipeline
        async function loadPipeline() {
            try {
                let query = supabase
                    .from('opportunities')
                    .select(`
                        *,
                        companies (name, industry),
                        contacts (first_name, last_name)
                    `)
                    .not('stage', 'in', '("closed-won","closed-lost")')
                    .order('expected_close_date', { ascending: true });

                // Filter by owner if viewing "my" opportunities
                if (currentView === 'my' && currentUserId) {
                    query = query.eq('owner_id', currentUserId);
                }

                const { data: opportunities, error } = await query;

                if (error) throw error;

                // Group by stage
                const pipeline = {};
                Object.keys(STAGES).forEach(stage => {
                    if (stage !== 'closed-won' && stage !== 'closed-lost') {
                        pipeline[stage] = [];
                    }
                });

                opportunities.forEach(opp => {
                    if (pipeline[opp.stage]) {
                        pipeline[opp.stage].push(opp);
                    }
                });

                renderPipeline(pipeline);

            } catch (error) {
                console.error('Error loading pipeline:', error);
                document.getElementById('pipelineLoading').innerHTML = '<p>Error loading pipeline. Please refresh.</p>';
            }
        }

        // Render pipeline
        function renderPipeline(pipeline) {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            Object.keys(pipeline).sort((a, b) => STAGES[a].order - STAGES[b].order).forEach(stage => {
                const opportunities = pipeline[stage];

                const stageDiv = document.createElement('div');
                stageDiv.className = 'pipeline-stage';

                const header = document.createElement('div');
                header.className = 'pipeline-stage-header';
                header.innerHTML = `
                    <span>${STAGES[stage].name}</span>
                    <span class="stage-count">${opportunities.length}</span>
                `;
                stageDiv.appendChild(header);

                opportunities.forEach(opp => {
                    const card = document.createElement('div');
                    card.className = 'opportunity-card';
                    card.onclick = () => window.location.href = `/crm/opportunity.html?id=${opp.id}`;

                    card.innerHTML = `
                        <div class="title">${opp.title}</div>
                        <div class="company">${opp.companies?.name || 'Unknown Company'}</div>
                        <div class="value">${formatCurrency(opp.value)}</div>
                        <div class="meta">
                            ${opp.managers_count ? opp.managers_count + ' managers' : ''}
                            ${opp.expected_close_date ? '‚Ä¢ Close: ' + formatDate(opp.expected_close_date) : ''}
                        </div>
                    `;
                    stageDiv.appendChild(card);
                });

                if (opportunities.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = 'var(--text-secondary)';
                    emptyMsg.style.fontSize = '0.9rem';
                    emptyMsg.style.marginTop = '1rem';
                    emptyMsg.textContent = 'No opportunities';
                    stageDiv.appendChild(emptyMsg);
                }

                container.appendChild(stageDiv);
            });

            document.getElementById('pipelineLoading').style.display = 'none';
            container.style.display = 'grid';
        }

        // Toggle between opportunity and company pipeline views
        let pipelineViewMode = 'opportunity'; // 'opportunity' or 'company'

        function togglePipelineView() {
            if (pipelineViewMode === 'opportunity') {
                pipelineViewMode = 'company';
                document.getElementById('viewToggleText').textContent = 'View by Opportunity';
                document.getElementById('pipelineContainer').style.display = 'none';
                document.getElementById('companyPipelineContainer').style.display = 'grid';
                loadCompanyPipeline();
            } else {
                pipelineViewMode = 'opportunity';
                document.getElementById('viewToggleText').textContent = 'View by Company';
                document.getElementById('pipelineContainer').style.display = 'grid';
                document.getElementById('companyPipelineContainer').style.display = 'none';
            }
        }

        // Load company-based pipeline
        async function loadCompanyPipeline() {
            try {
                let query = supabase
                    .from('opportunities')
                    .select(`
                        *,
                        companies (id, name, industry)
                    `)
                    .not('stage', 'in', '("closed-won","closed-lost")')
                    .order('expected_close_date', { ascending: true });

                // Filter by owner if viewing "my" opportunities
                if (currentView === 'my' && currentUserId) {
                    query = query.eq('owner_id', currentUserId);
                }

                const { data: opportunities, error } = await query;

                if (error) throw error;

                // Group by company, then find most advanced stage
                const companyMap = {};

                opportunities.forEach(opp => {
                    const companyId = opp.company_id;
                    const companyName = opp.companies?.name || 'Unknown Company';

                    if (!companyMap[companyId]) {
                        companyMap[companyId] = {
                            id: companyId,
                            name: companyName,
                            opportunities: [],
                            totalValue: 0,
                            mostAdvancedStage: 'lead',
                            mostAdvancedStageOrder: STAGES['lead'].order
                        };
                    }

                    companyMap[companyId].opportunities.push(opp);
                    companyMap[companyId].totalValue += opp.value || 0;

                    // Track most advanced stage
                    const stageOrder = STAGES[opp.stage]?.order || 0;
                    if (stageOrder > companyMap[companyId].mostAdvancedStageOrder) {
                        companyMap[companyId].mostAdvancedStage = opp.stage;
                        companyMap[companyId].mostAdvancedStageOrder = stageOrder;
                    }
                });

                // Group companies by their most advanced stage
                const pipeline = {};
                Object.keys(STAGES).forEach(stage => {
                    if (stage !== 'closed-won' && stage !== 'closed-lost') {
                        pipeline[stage] = [];
                    }
                });

                Object.values(companyMap).forEach(company => {
                    if (pipeline[company.mostAdvancedStage]) {
                        pipeline[company.mostAdvancedStage].push(company);
                    }
                });

                renderCompanyPipeline(pipeline);

            } catch (error) {
                console.error('Error loading company pipeline:', error);
                document.getElementById('pipelineLoading').innerHTML = '<p>Error loading pipeline. Please refresh.</p>';
            }
        }

        // Render company-based pipeline
        function renderCompanyPipeline(pipeline) {
            const container = document.getElementById('companyPipelineContainer');
            container.innerHTML = '';

            Object.keys(pipeline).sort((a, b) => STAGES[a].order - STAGES[b].order).forEach(stage => {
                const companies = pipeline[stage];

                const stageDiv = document.createElement('div');
                stageDiv.className = 'pipeline-stage';

                const header = document.createElement('div');
                header.className = 'pipeline-stage-header';
                header.innerHTML = `
                    <span>${STAGES[stage].name}</span>
                    <span class="stage-count">${companies.length}</span>
                `;
                stageDiv.appendChild(header);

                companies.forEach(company => {
                    const card = document.createElement('div');
                    card.className = 'opportunity-card';
                    card.onclick = () => window.location.href = `/crm/companies.html?highlight=${company.id}`;

                    const oppCount = company.opportunities.length;
                    const oppList = company.opportunities.map(o => o.title).join(', ');
                    const totalManagers = company.opportunities.reduce((sum, o) => sum + (o.managers_count || 0), 0);

                    card.innerHTML = `
                        <div class="title">${company.name}</div>
                        <div class="company" style="color: var(--primary-green); font-weight: 600;">
                            ${oppCount} ${oppCount === 1 ? 'Opportunity' : 'Opportunities'}
                        </div>
                        <div class="value">${formatCurrency(company.totalValue)}</div>
                        <div class="meta">
                            ${totalManagers ? totalManagers + ' total managers' : ''}
                            ${company.opportunities[0]?.expected_close_date ? '‚Ä¢ Next close: ' + formatDate(company.opportunities[0].expected_close_date) : ''}
                        </div>
                        <div class="meta" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${oppList}">
                            ${oppList}
                        </div>
                    `;
                    stageDiv.appendChild(card);
                });

                if (companies.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.color = 'var(--text-secondary)';
                    emptyMsg.style.fontSize = '0.9rem';
                    emptyMsg.style.marginTop = '1rem';
                    emptyMsg.textContent = 'No companies';
                    stageDiv.appendChild(emptyMsg);
                }

                container.appendChild(stageDiv);
            });

            document.getElementById('pipelineLoading').style.display = 'none';
            container.style.display = 'grid';
        }

        // Load recent activities
        async function loadActivities() {
            try {
                let query = supabase
                    .from('activities')
                    .select(`
                        *,
                        companies (name),
                        opportunities (title)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                // Filter by owner if viewing "my" activities
                if (currentView === 'my' && currentUserId) {
                    query = query.eq('owner_id', currentUserId);
                }

                const { data: activities, error } = await query;

                if (error) throw error;

                renderActivities(activities);

            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // Render activities
        function renderActivities(activities) {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = '';

            activities.forEach(activity => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="badge">${activity.type}</span></td>
                    <td>${activity.subject}</td>
                    <td>${activity.companies?.name || '-'}</td>
                    <td>${formatDate(activity.created_at)}</td>
                    <td><span class="badge ${activity.completed ? 'badge-won' : 'badge-lead'}">${activity.completed ? 'Complete' : 'Pending'}</span></td>
                `;
            });

            document.getElementById('activitiesLoading').style.display = 'none';
            document.getElementById('activitiesContainer').style.display = 'block';
        }

        // Refresh pipeline
        async function refreshPipeline() {
            document.getElementById('pipelineLoading').style.display = 'block';
            document.getElementById('pipelineContainer').style.display = 'none';
            document.getElementById('companyPipelineContainer').style.display = 'none';

            if (pipelineViewMode === 'company') {
                await Promise.all([loadMetrics(), loadCompanyPipeline()]);
            } else {
                await Promise.all([loadMetrics(), loadPipeline()]);
            }
        }

        // Show new opportunity modal (placeholder)
        function showNewOpportunityModal() {
            alert('New opportunity form coming soon! For now, use Supabase dashboard to add opportunities.');
        }

        // Load today's tasks
        async function loadTodaysTasks() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowEnd = new Date(tomorrow);
                tomorrowEnd.setHours(23, 59, 59, 999);

                // Get ALL activities (not just tasks) that have a due date and are not completed
                // This includes meetings, calls, emails with due dates
                const { data: activities, error: activitiesError } = await supabase
                    .from('activities')
                    .select('*')
                    .not('due_date', 'is', null)
                    .lte('due_date', tomorrowEnd.toISOString())
                    .order('due_date', { ascending: true });

                console.log('Activities loaded:', activities, 'Error:', activitiesError);

                // Filter out completed activities (check both status and completed fields)
                const incompleteActivities = (activities || []).filter(activity => {
                    // If status field exists, use it; otherwise fall back to completed field
                    if (activity.status) {
                        return activity.status !== 'completed';
                    }
                    return !activity.completed;
                });

                // Get company names separately if we have activities
                if (incompleteActivities.length > 0) {
                    for (let activity of incompleteActivities) {
                        if (activity.company_id) {
                            const { data: company } = await supabase
                                .from('companies')
                                .select('name')
                                .eq('id', activity.company_id)
                                .single();
                            activity.company = company;
                        }
                    }
                }

                const overdue = [];
                const dueSoon = [];

                incompleteActivities.forEach(task => {
                    const dueDate = new Date(task.due_date);
                    dueDate.setHours(0, 0, 0, 0);

                    if (dueDate < today) {
                        overdue.push(task);
                    } else if (dueDate <= tomorrow) {
                        dueSoon.push(task);
                    }
                });

                // Get opportunities that need follow-up (closing in next 7 days)
                const sevenDaysFromNow = new Date(today);
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

                const { data: opps, error: oppsError } = await supabase
                    .from('opportunities')
                    .select('*')
                    .in('stage', ['demo-scheduled', 'proposal', 'negotiation'])
                    .lte('expected_close_date', sevenDaysFromNow.toISOString())
                    .order('expected_close_date', { ascending: true })
                    .limit(5);

                console.log('Opportunities loaded:', opps, 'Error:', oppsError);

                // Get company names for opportunities
                if (opps && opps.length > 0) {
                    for (let opp of opps) {
                        if (opp.company_id) {
                            const { data: company } = await supabase
                                .from('companies')
                                .select('name')
                                .eq('id', opp.company_id)
                                .single();
                            opp.company = company;
                        }
                    }
                }

                document.getElementById('tasksLoading').style.display = 'none';

                if (overdue.length === 0 && dueSoon.length === 0 && (!opps || opps.length === 0)) {
                    document.getElementById('noTasks').style.display = 'block';
                    return;
                }

                document.getElementById('tasksContent').style.display = 'block';

                // Activity type icons
                const activityIcons = {
                    task: '‚úÖ',
                    meeting: 'üìÖ',
                    call: 'üìû',
                    email: '‚úâÔ∏è',
                    note: 'üìù',
                    demo: 'üéØ'
                };

                // Render overdue tasks
                if (overdue.length > 0) {
                    document.getElementById('overdueTasksList').innerHTML = `
                        <h3 style="color: var(--danger-red); margin-bottom: 1rem;">‚ö†Ô∏è Overdue (${overdue.length})</h3>
                        ${overdue.map(task => {
                            const icon = activityIcons[task.type] || 'üìã';
                            return `
                            <div onclick="window.location.href='/crm/activities.html?id=${task.id}'" style="padding: 1rem; border-left: 4px solid var(--danger-red); background: #FEE2E2; border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow=''; this.style.transform='';">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${icon} ${task.subject}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${task.company?.name || 'No company'} ‚Ä¢ Due: ${new Date(task.due_date).toLocaleDateString()}
                                </div>
                            </div>
                        `}).join('')}
                    `;
                }

                // Render due today/tomorrow
                if (dueSoon.length > 0) {
                    const todayStr = today.toISOString().split('T')[0];
                    document.getElementById('dueTodayList').innerHTML = `
                        <h3 style="color: var(--warning-orange); margin-bottom: 1rem;">üìÖ Due Today/Tomorrow (${dueSoon.length})</h3>
                        ${dueSoon.map(task => {
                            const dueDate = new Date(task.due_date);
                            const dueDateStr = dueDate.toISOString().split('T')[0];
                            const isToday = dueDateStr === todayStr;
                            const icon = activityIcons[task.type] || 'üìã';
                            return `
                            <div onclick="window.location.href='/crm/activities.html?id=${task.id}'" style="padding: 1rem; border-left: 4px solid var(--warning-orange); background: #FEF3C7; border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow=''; this.style.transform='';">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${icon} ${task.subject}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${task.company?.name || 'No company'} ‚Ä¢ Due: ${isToday ? 'Today' : 'Tomorrow'} (${dueDate.toLocaleDateString()})
                                </div>
                            </div>
                        `;}).join('')}
                    `;
                }

                // Render follow-ups
                if (opps && opps.length > 0) {
                    document.getElementById('followUpsList').innerHTML = `
                        <h3 style="color: var(--primary-green); margin-bottom: 1rem;">üéØ Follow-Ups Needed</h3>
                        ${opps.map(opp => `
                            <div onclick="window.location.href='/crm/opportunity.html?id=${opp.id}'" style="padding: 1rem; border-left: 4px solid var(--primary-green); background: var(--light-green); border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow=''; this.style.transform='';">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${opp.title}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${opp.company?.name || 'No company'} ‚Ä¢ ${opp.stage.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} ‚Ä¢ Close: ${new Date(opp.expected_close_date).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }

            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksLoading').innerHTML = `<div style="color: var(--danger-red);">Error loading tasks: ${error.message}</div>`;
            }
        }

        // Initialize page
        async function initPage() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            await Promise.all([
                loadMetrics(),
                loadPipeline(),
                loadActivities(),
                loadTodaysTasks()
            ]);
        }

        // ===== NEW OPPORTUNITY MODAL FUNCTIONS =====

        // Show modal and load companies
        async function showNewOpportunityModal() {
            document.getElementById('newOpportunityModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            await loadCompanies();
            calculateFinancials(); // Set initial values
        }

        // Close modal
        function closeNewOpportunityModal() {
            document.getElementById('newOpportunityModal').classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('newOpportunityForm').reset();
            hideAddCompanyForm();
            hideAddContactForm();
        }

        // Load companies into dropdown
        async function loadCompanies() {
            try {
                const { data, error } = await supabase
                    .from('companies')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('oppCompany');
                select.innerHTML = '<option value="">Select a company...</option>';

                data.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        // Load contacts for selected company
        async function loadCompanyContacts() {
            const companyId = document.getElementById('oppCompany').value;
            const contactSelect = document.getElementById('oppContact');

            contactSelect.innerHTML = '<option value="">Select a contact...</option>';

            if (!companyId) return;

            try {
                const { data, error } = await supabase
                    .from('contacts')
                    .select('id, first_name, last_name, title')
                    .eq('company_id', companyId)
                    .order('first_name');

                if (error) throw error;

                data.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.id;
                    option.textContent = `${contact.first_name} ${contact.last_name}${contact.title ? ' - ' + contact.title : ''}`;
                    contactSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // Show/hide add company form
        function showAddCompanyForm() {
            document.getElementById('addCompanyForm').style.display = 'block';
        }

        function hideAddCompanyForm() {
            document.getElementById('addCompanyForm').style.display = 'none';
            document.getElementById('newCompanyName').value = '';
            document.getElementById('newCompanyIndustry').value = '';
            document.getElementById('newCompanyType').value = 'customer';
        }

        // Save new company
        async function saveNewCompany() {
            const name = document.getElementById('newCompanyName').value;
            const industry = document.getElementById('newCompanyIndustry').value;
            const companyType = document.getElementById('newCompanyType').value;

            if (!name) {
                alert('Please enter a company name');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('companies')
                    .insert([{
                        name: name,
                        industry: industry,
                        company_type: companyType,
                        status: 'prospect'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Reload companies and select the new one
                await loadCompanies();
                document.getElementById('oppCompany').value = data.id;
                await loadCompanyContacts();
                hideAddCompanyForm();

            } catch (error) {
                console.error('Error saving company:', error);
                alert('Failed to save company');
            }
        }

        // Show/hide add contact form
        function showAddContactForm() {
            const companyId = document.getElementById('oppCompany').value;
            if (!companyId) {
                alert('Please select a company first');
                return;
            }
            document.getElementById('addContactForm').style.display = 'block';
        }

        function hideAddContactForm() {
            document.getElementById('addContactForm').style.display = 'none';
            document.getElementById('newContactFirstName').value = '';
            document.getElementById('newContactLastName').value = '';
            document.getElementById('newContactEmail').value = '';
            document.getElementById('newContactTitle').value = '';
        }

        // Save new contact
        async function saveNewContact() {
            const companyId = document.getElementById('oppCompany').value;
            const firstName = document.getElementById('newContactFirstName').value;
            const lastName = document.getElementById('newContactLastName').value;
            const email = document.getElementById('newContactEmail').value;
            const title = document.getElementById('newContactTitle').value;

            if (!firstName || !lastName) {
                alert('Please enter first and last name');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('contacts')
                    .insert([{
                        company_id: companyId,
                        first_name: firstName,
                        last_name: lastName,
                        email: email,
                        title: title
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Reload contacts and select the new one
                await loadCompanyContacts();
                document.getElementById('oppContact').value = data.id;
                hideAddContactForm();

            } catch (error) {
                console.error('Error saving contact:', error);
                alert('Failed to save contact');
            }
        }

        // Calculate financials
        function calculateFinancials() {
            const managers = parseInt(document.getElementById('oppManagers').value) || 0;
            const pricePerManager = parseInt(document.getElementById('oppPricePerManager').value) || 295;

            const mrr = managers * pricePerManager;
            const acv = mrr * 12;

            document.getElementById('oppMRR').value = mrr;
            document.getElementById('oppACV').value = acv;
        }

        // Save new opportunity
        async function saveNewOpportunity(event) {
            event.preventDefault();

            const companyId = document.getElementById('oppCompany').value;
            const contactId = document.getElementById('oppContact').value || null;
            const title = document.getElementById('oppTitle').value;
            const stage = document.getElementById('oppStage').value;
            const probability = parseInt(document.getElementById('oppProbability').value) || 0;
            const source = document.getElementById('oppSource').value;
            const closeDate = document.getElementById('oppCloseDate').value || null;
            const managers = parseInt(document.getElementById('oppManagers').value) || 1;
            const pricePerManager = parseInt(document.getElementById('oppPricePerManager').value) || 295;
            const mrr = parseInt(document.getElementById('oppMRR').value) || 0;
            const acv = parseInt(document.getElementById('oppACV').value) || 0;
            const employees = parseInt(document.getElementById('oppEmployees').value) || null;
            const nextStep = document.getElementById('oppNextStep').value;
            const notes = document.getElementById('oppNotes').value;

            try {
                const { data, error } = await supabase
                    .from('opportunities')
                    .insert([{
                        company_id: companyId,
                        contact_id: contactId,
                        title: title,
                        stage: stage,
                        probability: probability,
                        source: source,
                        expected_close_date: closeDate,
                        managers_count: managers,
                        monthly_recurring_revenue: mrr,
                        annual_contract_value: acv,
                        value: acv,
                        employees_covered: employees,
                        next_step: nextStep,
                        notes: notes,
                        owner_id: currentUserId
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Close modal and redirect to new opportunity
                closeNewOpportunityModal();
                alert('Opportunity created successfully!');
                window.location.href = `/crm/opportunity.html?id=${data.id}`;

            } catch (error) {
                console.error('Error creating opportunity:', error);
                alert('Failed to create opportunity: ' + error.message);
            }
        }

        // Load everything when page loads
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
