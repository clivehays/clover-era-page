<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opportunity Details - Clover ERA CRM</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="/images/clover-favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-green: #10b981;
            --dark-green: #059669;
            --light-green: #d1fae5;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --background: #f9fafb;
            --medium-gray: #e5e7eb;
            --border-color: #d1d5db;
            --danger-red: #EF4444;
            --warning-orange: #F59E0B;
            --light-gray: #F8F9FA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light-gray);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: var(--primary-green);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-green);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: var(--medium-gray);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-logout:hover {
            background: var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .detail-value {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .stage-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stage-lead { background: #E0F2FE; color: #0369A1; }
        .stage-qualified { background: #DBEAFE; color: #1E40AF; }
        .stage-demo-scheduled { background: #E0E7FF; color: #4338CA; }
        .stage-demo-completed { background: #F3E8FF; color: #7C3AED; }
        .stage-proposal { background: #FEF3C7; color: #D97706; }
        .stage-negotiation { background: #FED7AA; color: #C2410C; }
        .stage-pilot { background: #D1FAE5; color: #047857; }
        .stage-closed-won { background: #D1FAE5; color: #065F46; }
        .stage-closed-lost { background: #FEE2E2; color: #991B1B; }

        .timeline {
            margin-top: 1.5rem;
        }

        .timeline-item {
            padding: 1rem;
            border-left: 3px solid var(--primary-green);
            margin-bottom: 1rem;
            background: var(--light-gray);
            border-radius: 0 8px 8px 0;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .timeline-content {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--medium-gray);
            border-top: 3px solid var(--primary-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 2px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.75rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">Clover ERA CRM</div>
        <div class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="companies.html">Companies</a>
            <a href="activities.html">Activities</a>
            <a href="kanban.html">Kanban</a>
            <a href="admin.html" id="adminLink" style="display: none;">Admin</a>
            <span id="userInfo" style="color: var(--text-secondary);"></span>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading opportunity...</p>
        </div>

        <!-- Content -->
        <div id="content" style="display: none;">
            <!-- Page Header -->
            <div class="page-header">
                <h1 id="opportunityTitle">Opportunity Details</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showEditModal()">Edit Opportunity</button>
                    <button class="btn" style="background: var(--danger-red); color: white;" onclick="deleteOpportunity()">Delete</button>
                </div>
            </div>

            <div class="content-grid">
                <!-- Main Content -->
                <div>
                    <!-- Opportunity Details -->
                    <div class="section">
                        <h2 class="section-header">Opportunity Information</h2>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Stage</div>
                                <div class="detail-value" id="oppStage"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Value</div>
                                <div class="detail-value" id="oppValue"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Probability</div>
                                <div class="detail-value" id="oppProbability"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Expected Close Date</div>
                                <div class="detail-value" id="oppCloseDate"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Manager Count</div>
                                <div class="detail-value" id="oppManagers"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">MRR</div>
                                <div class="detail-value" id="oppMRR"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Source</div>
                                <div class="detail-value" id="oppSource"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Owner</div>
                                <div class="detail-value" id="oppOwner"></div>
                            </div>
                        </div>
                        <div class="detail-item" style="margin-top: 1.5rem;">
                            <div class="detail-label">Next Step</div>
                            <div class="detail-value" id="oppNextStep"></div>
                        </div>
                        <div class="detail-item" style="margin-top: 1.5rem;">
                            <div class="detail-label">Notes</div>
                            <div class="detail-value" id="oppNotes" style="white-space: pre-wrap;"></div>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="section">
                        <h2 class="section-header">Activity Timeline (<span id="activityCount">0</span>)</h2>
                        <button class="btn btn-secondary" onclick="showAddActivityModal()" style="margin-bottom: 1rem;">+ Add Activity</button>
                        <div id="activityTimeline" class="timeline">
                            <p style="color: var(--text-secondary);">No activities yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div>
                    <!-- Outlook/Teams Integration -->
                    <div class="section">
                        <h2 class="section-header">Quick Actions</h2>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="scheduleTeamsMeeting()" style="width: 100%;">
                                üìÖ Schedule Teams Meeting
                            </button>
                            <button class="btn btn-secondary" onclick="showLogEmailModal()" style="width: 100%;">
                                ‚úâÔ∏è Log Email
                            </button>
                            <button class="btn btn-secondary" onclick="generateEmailTemplate()" style="width: 100%;">
                                üìù Copy Demo Email
                            </button>
                        </div>
                    </div>

                    <!-- Company Info -->
                    <div class="section">
                        <h2 class="section-header">Company</h2>
                        <div id="companyInfo">
                            <div class="detail-item" style="margin-bottom: 1rem;">
                                <div class="detail-label">Company Name</div>
                                <div class="detail-value" id="companyName"></div>
                            </div>
                            <div class="detail-item" style="margin-bottom: 1rem;">
                                <div class="detail-label">Industry</div>
                                <div class="detail-value" id="companyIndustry"></div>
                            </div>
                            <button class="btn btn-secondary" onclick="viewCompany()" style="width: 100%;">View Company Details</button>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="section">
                        <h2 class="section-header">Primary Contact</h2>
                        <div id="contactInfo">
                            <p style="color: var(--text-secondary);">No contact assigned</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Opportunity Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Opportunity</h2>
                <button class="modal-close" onclick="hideEditModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveOpportunity(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Opportunity Title</label>
                        <input type="text" id="editTitle" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Stage</label>
                            <select id="editStage" required>
                                <option value="lead">Lead</option>
                                <option value="qualified">Qualified</option>
                                <option value="demo-scheduled">Demo Scheduled</option>
                                <option value="demo-completed">Demo Completed</option>
                                <option value="proposal">Proposal</option>
                                <option value="negotiation">Negotiation</option>
                                <option value="pilot">Pilot</option>
                                <option value="closed-won">Closed Won</option>
                                <option value="closed-lost">Closed Lost</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Probability (%)</label>
                            <input type="number" id="editProbability" min="0" max="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Expected Close Date</label>
                            <input type="date" id="editCloseDate">
                        </div>
                        <div class="form-group">
                            <label>Source</label>
                            <select id="editSource">
                                <option value="inbound">Inbound</option>
                                <option value="outbound">Outbound</option>
                                <option value="partner">Partner</option>
                                <option value="referral">Referral</option>
                                <option value="event">Event</option>
                                <option value="website">Website</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Manager Count</label>
                            <input type="number" id="editManagers" min="1">
                        </div>
                        <div class="form-group">
                            <label>MRR</label>
                            <input type="number" id="editMRR">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Next Step</label>
                        <input type="text" id="editNextStep">
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editNotes" rows="4"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Activity</h2>
                <button class="modal-close" onclick="hideAddActivityModal()">&times;</button>
            </div>
            <form id="activityForm" onsubmit="saveActivity(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="activityType" required>
                                <option value="call">Call</option>
                                <option value="meeting">Meeting</option>
                                <option value="email">Email</option>
                                <option value="demo">Demo</option>
                                <option value="note">Note</option>
                                <option value="task">Task</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="activityDueDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="activitySubject" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="activityDescription" rows="4"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideAddActivityModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Activity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Log Email Modal -->
    <div id="logEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Log Email</h2>
                <button class="modal-close" onclick="hideLogEmailModal()">&times;</button>
            </div>
            <form id="logEmailForm" onsubmit="saveLoggedEmail(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email Subject</label>
                        <input type="text" id="logEmailSubject" required placeholder="e.g., Demo follow-up">
                    </div>

                    <div class="form-group">
                        <label>Date Sent/Received</label>
                        <input type="datetime-local" id="logEmailDate" required>
                    </div>

                    <div class="form-group">
                        <label>Summary</label>
                        <textarea id="logEmailSummary" rows="4" placeholder="Brief summary of the email content..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideLogEmailModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Log Email</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://drugebiitlcjkknjfxeh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydWdlYmlpdGxjamtrbmpmeGVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjY1MDQsImV4cCI6MjA3ODM0MjUwNH0.HaYY0UxEC4cYyC3V4O0RyIkm7JTljnQapUnaeBoXba8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentOpportunity = null;
        let currentUserId = null;
        let opportunityId = null;

        // Check authentication
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/crm/login.html';
                return false;
            }

            currentUserId = session.user.id;
            document.getElementById('userInfo').textContent = session.user.email;

            // Check if user is admin
            const { data: profile } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (profile && profile.role === 'admin') {
                document.getElementById('adminLink').style.display = 'inline-block';
            }

            return true;
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = '/crm/login.html';
        }

        // Format currency
        function formatCurrency(amount) {
            if (!amount) return '$0';
            return '$' + amount.toLocaleString();
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format stage
        function formatStage(stage) {
            const stages = {
                'lead': 'Lead',
                'qualified': 'Qualified',
                'demo-scheduled': 'Demo Scheduled',
                'demo-completed': 'Demo Completed',
                'proposal': 'Proposal',
                'negotiation': 'Negotiation',
                'pilot': 'Pilot',
                'closed-won': 'Closed Won',
                'closed-lost': 'Closed Lost'
            };
            return stages[stage] || stage;
        }

        // Load opportunity
        async function loadOpportunity() {
            try {
                const { data: opp, error } = await supabase
                    .from('opportunities')
                    .select(`
                        *,
                        companies (id, name, industry),
                        contacts (id, first_name, last_name, email, phone, title)
                    `)
                    .eq('id', opportunityId)
                    .single();

                if (error) throw error;

                currentOpportunity = opp;

                // Get owner details
                if (opp.owner_id) {
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('full_name, email')
                        .eq('id', opp.owner_id)
                        .single();
                    opp.owner = profile;
                }

                renderOpportunity(opp);
                await loadActivities();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading opportunity:', error);
                document.getElementById('loadingState').innerHTML = `
                    <p style="color: var(--danger-red);">Error loading opportunity: ${error.message}</p>
                `;
            }
        }

        // Render opportunity
        function renderOpportunity(opp) {
            document.getElementById('opportunityTitle').textContent = opp.title;

            const stageBadge = `<span class="stage-badge stage-${opp.stage}">${formatStage(opp.stage)}</span>`;
            document.getElementById('oppStage').innerHTML = stageBadge;

            document.getElementById('oppValue').textContent = formatCurrency(opp.value || opp.annual_contract_value);
            document.getElementById('oppProbability').textContent = (opp.probability || 0) + '%';
            document.getElementById('oppCloseDate').textContent = formatDate(opp.expected_close_date);
            document.getElementById('oppManagers').textContent = opp.managers_count || 'Not set';
            document.getElementById('oppMRR').textContent = formatCurrency(opp.monthly_recurring_revenue);
            document.getElementById('oppSource').textContent = (opp.source || 'Not set').charAt(0).toUpperCase() + (opp.source || 'Not set').slice(1);
            document.getElementById('oppOwner').textContent = opp.owner?.full_name || opp.owner?.email || 'Unassigned';
            document.getElementById('oppNextStep').textContent = opp.next_step || 'No next step defined';
            document.getElementById('oppNotes').textContent = opp.notes || 'No notes';

            // Company info
            if (opp.companies) {
                document.getElementById('companyName').textContent = opp.companies.name;
                document.getElementById('companyIndustry').textContent = opp.companies.industry || 'Not specified';
            }

            // Contact info
            if (opp.contacts) {
                const contact = opp.contacts;
                document.getElementById('contactInfo').innerHTML = `
                    <div class="detail-item" style="margin-bottom: 0.5rem;">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${contact.first_name} ${contact.last_name}</div>
                    </div>
                    ${contact.title ? `
                        <div class="detail-item" style="margin-bottom: 0.5rem;">
                            <div class="detail-label">Title</div>
                            <div class="detail-value">${contact.title}</div>
                        </div>
                    ` : ''}
                    ${contact.email ? `
                        <div class="detail-item" style="margin-bottom: 0.5rem;">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${contact.email}</div>
                        </div>
                    ` : ''}
                    ${contact.phone ? `
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${contact.phone}</div>
                        </div>
                    ` : ''}
                `;
            }
        }

        // Load activities
        async function loadActivities() {
            try {
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('opportunity_id', opportunityId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                document.getElementById('activityCount').textContent = activities.length;

                if (activities.length > 0) {
                    document.getElementById('activityTimeline').innerHTML = activities.map(activity => `
                        <div class="timeline-item">
                            <div class="timeline-header">
                                <span class="timeline-title">${activity.type.toUpperCase()}: ${activity.subject}</span>
                                <span class="timeline-date">${formatDate(activity.created_at)}</span>
                            </div>
                            ${activity.description ? `<div class="timeline-content">${activity.description}</div>` : ''}
                            ${activity.due_date ? `<div class="timeline-content" style="margin-top: 0.5rem;"><strong>Due:</strong> ${formatDate(activity.due_date)}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    document.getElementById('activityTimeline').innerHTML = '<p style="color: var(--text-secondary);">No activities yet.</p>';
                }

            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // Show edit modal
        function showEditModal() {
            if (!currentOpportunity) return;

            document.getElementById('editTitle').value = currentOpportunity.title;
            document.getElementById('editStage').value = currentOpportunity.stage;
            document.getElementById('editProbability').value = currentOpportunity.probability || 0;
            document.getElementById('editCloseDate').value = currentOpportunity.expected_close_date || '';
            document.getElementById('editSource').value = currentOpportunity.source || 'inbound';
            document.getElementById('editManagers').value = currentOpportunity.managers_count || '';
            document.getElementById('editMRR').value = currentOpportunity.monthly_recurring_revenue || '';
            document.getElementById('editNextStep').value = currentOpportunity.next_step || '';
            document.getElementById('editNotes').value = currentOpportunity.notes || '';

            document.getElementById('editModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Save opportunity
        async function saveOpportunity(event) {
            event.preventDefault();

            const updates = {
                title: document.getElementById('editTitle').value,
                stage: document.getElementById('editStage').value,
                probability: parseInt(document.getElementById('editProbability').value) || 0,
                expected_close_date: document.getElementById('editCloseDate').value || null,
                source: document.getElementById('editSource').value,
                managers_count: parseInt(document.getElementById('editManagers').value) || null,
                monthly_recurring_revenue: parseInt(document.getElementById('editMRR').value) || null,
                next_step: document.getElementById('editNextStep').value,
                notes: document.getElementById('editNotes').value
            };

            // Calculate ACV from MRR
            if (updates.monthly_recurring_revenue) {
                updates.annual_contract_value = updates.monthly_recurring_revenue * 12;
                updates.value = updates.annual_contract_value;
            }

            try {
                const { error } = await supabase
                    .from('opportunities')
                    .update(updates)
                    .eq('id', opportunityId);

                if (error) throw error;

                hideEditModal();
                await loadOpportunity();
                alert('Opportunity updated successfully!');

            } catch (error) {
                console.error('Error updating opportunity:', error);
                alert('Failed to update opportunity: ' + error.message);
            }
        }

        // Delete opportunity
        async function deleteOpportunity() {
            if (!currentOpportunity) return;

            const confirmMessage = `Are you sure you want to delete "${currentOpportunity.title}"?\n\nThis will also delete all associated activities.\n\nThis action cannot be undone.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Delete activities first
                await supabase
                    .from('activities')
                    .delete()
                    .eq('opportunity_id', opportunityId);

                // Delete opportunity
                const { error } = await supabase
                    .from('opportunities')
                    .delete()
                    .eq('id', opportunityId);

                if (error) throw error;

                alert('Opportunity deleted successfully!');
                window.location.href = '/crm/index.html';

            } catch (error) {
                console.error('Error deleting opportunity:', error);
                alert('Failed to delete opportunity: ' + error.message);
            }
        }

        // Show add activity modal
        function showAddActivityModal() {
            document.getElementById('activityForm').reset();
            document.getElementById('activityModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideAddActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Save activity
        async function saveActivity(event) {
            event.preventDefault();

            const activity = {
                opportunity_id: opportunityId,
                company_id: currentOpportunity.company_id,
                type: document.getElementById('activityType').value,
                subject: document.getElementById('activitySubject').value,
                description: document.getElementById('activityDescription').value,
                due_date: document.getElementById('activityDueDate').value || null,
                owner_id: currentUserId,
                completed: false
            };

            try {
                const { error } = await supabase
                    .from('activities')
                    .insert([activity]);

                if (error) throw error;

                hideAddActivityModal();
                await loadActivities();
                alert('Activity added successfully!');

            } catch (error) {
                console.error('Error adding activity:', error);
                alert('Failed to add activity: ' + error.message);
            }
        }

        // View company
        function viewCompany() {
            if (currentOpportunity && currentOpportunity.company_id) {
                window.location.href = `/crm/companies.html#${currentOpportunity.company_id}`;
            }
        }

        // ======== OUTLOOK/TEAMS INTEGRATION - PHASE 1 ========

        // Format date for ICS file (iCalendar format)
        function formatICSDate(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        // Escape text for ICS format
        function escapeICSText(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\')
                      .replace(/;/g, '\\;')
                      .replace(/,/g, '\\,')
                      .replace(/\n/g, '\\n');
        }

        // 1. Schedule Teams Meeting - Downloads .ics file
        async function scheduleTeamsMeeting() {
            if (!currentOpportunity) {
                alert('Please wait for opportunity to load.');
                return;
            }

            const contact = currentOpportunity.contacts;
            if (!contact || !contact.email) {
                alert('No contact email found. Please add a contact to this opportunity first.');
                return;
            }

            const company = currentOpportunity.companies;

            // Default meeting to next week, 2pm
            const meetingDate = new Date();
            meetingDate.setDate(meetingDate.getDate() + 7);
            meetingDate.setHours(14, 0, 0, 0);

            const meetingEnd = new Date(meetingDate);
            meetingEnd.setMinutes(meetingEnd.getMinutes() + 60); // 1 hour meeting

            // Get current user's email
            const { data: { session } } = await supabase.auth.getSession();
            const organizerEmail = session.user.email;

            // Build description
            const description = escapeICSText(
                `Demo meeting for ${company.name}\n\n` +
                `Opportunity: ${currentOpportunity.title}\n` +
                `Value: ${formatCurrency(currentOpportunity.value || currentOpportunity.annual_contract_value)}\n\n` +
                `Please join via Microsoft Teams.`
            );

            // Generate ICS file content with proper CRLF line endings
            const icsLines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Clover ERA CRM//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:REQUEST',
                'BEGIN:VEVENT',
                `UID:${currentOpportunity.id}-${Date.now()}@cloverera.com`,
                `DTSTAMP:${formatICSDate(new Date())}`,
                `DTSTART:${formatICSDate(meetingDate)}`,
                `DTEND:${formatICSDate(meetingEnd)}`,
                `SUMMARY:${escapeICSText('Demo - ' + currentOpportunity.title)}`,
                `DESCRIPTION:${description}`,
                'LOCATION:Microsoft Teams Meeting',
                `ORGANIZER:mailto:${organizerEmail}`,
                `ATTENDEE;ROLE=REQ-PARTICIPANT;RSVP=TRUE:mailto:${contact.email}`,
                'STATUS:CONFIRMED',
                'SEQUENCE:0',
                'TRANSP:OPAQUE',
                'END:VEVENT',
                'END:VCALENDAR'
            ];

            const icsContent = icsLines.join('\r\n');

            // Download the .ics file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demo-${company.name.replace(/\s+/g, '-')}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Log the meeting creation as an activity
            try {
                await supabase.from('activities').insert([{
                    opportunity_id: currentOpportunity.id,
                    company_id: currentOpportunity.company_id,
                    type: 'meeting',
                    subject: `Demo scheduled with ${company.name}`,
                    description: `Teams meeting invite sent to ${contact.first_name} ${contact.last_name} (${contact.email})`,
                    due_date: meetingDate.toISOString(),
                    owner_id: currentUserId,
                    completed: false
                }]);

                await loadActivities();
                alert('Meeting invite downloaded! Open the .ics file to add it to your Outlook calendar, then send the invite to the contact.');
            } catch (error) {
                console.error('Error logging meeting:', error);
                alert('Meeting invite downloaded, but failed to log activity in CRM.');
            }
        }

        // 2. Log Email Modal
        function showLogEmailModal() {
            if (!currentOpportunity) {
                alert('Please wait for opportunity to load.');
                return;
            }

            // Set default date to now
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('logEmailDate').value = localDateTime;

            document.getElementById('logEmailForm').reset();
            document.getElementById('logEmailDate').value = localDateTime;
            document.getElementById('logEmailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideLogEmailModal() {
            document.getElementById('logEmailModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function saveLoggedEmail(event) {
            event.preventDefault();

            const emailData = {
                opportunity_id: currentOpportunity.id,
                company_id: currentOpportunity.company_id,
                type: 'email',
                subject: document.getElementById('logEmailSubject').value,
                description: document.getElementById('logEmailSummary').value,
                due_date: new Date(document.getElementById('logEmailDate').value).toISOString(),
                owner_id: currentUserId,
                completed: true
            };

            try {
                const { error } = await supabase
                    .from('activities')
                    .insert([emailData]);

                if (error) throw error;

                hideLogEmailModal();
                await loadActivities();
                alert('Email logged successfully!');

            } catch (error) {
                console.error('Error logging email:', error);
                alert('Failed to log email: ' + error.message);
            }
        }

        // 3. Generate Email Template - Copy to clipboard
        async function generateEmailTemplate() {
            if (!currentOpportunity) {
                alert('Please wait for opportunity to load.');
                return;
            }

            const contact = currentOpportunity.contacts;
            if (!contact) {
                alert('No contact found for this opportunity.');
                return;
            }

            const company = currentOpportunity.companies;

            // Get current user info
            const { data: { session } } = await supabase.auth.getSession();
            const { data: profile } = await supabase
                .from('profiles')
                .select('full_name')
                .eq('id', session.user.id)
                .single();

            const userName = profile?.full_name || session.user.email;

            const template = `Subject: Demo Invitation - Clover ERA Manager Enablement

Hi ${contact.first_name},

Thank you for your interest in Clover ERA's manager enablement platform.

I'd like to schedule a 30-minute demo to show you how we help organizations identify struggling managers before they cause turnover and performance issues.

Key topics we'll cover:
- Early warning system for manager performance issues
- Anonymous feedback that managers actually want to hear
- Coaching pathways proven to improve retention

Based on your organization's ${currentOpportunity.managers_count || '[NUMBER]'} managers, we estimate this could help you avoid $${((currentOpportunity.managers_count || 10) * 150000 * 0.1).toLocaleString()} in turnover costs annually.

Does next week work for a brief demo? I'm happy to work around your schedule.

Best regards,
${userName}
Clover ERA

---
CRM Opportunity: ${currentOpportunity.title}
Value: ${formatCurrency(currentOpportunity.value || currentOpportunity.annual_contract_value)}`;

            try {
                await navigator.clipboard.writeText(template);
                alert('Email template copied to clipboard! Paste it into Outlook and customize as needed.');
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                // Fallback: show in alert for manual copy
                alert('Could not copy automatically. Here\'s the template:\n\n' + template);
            }
        }

        // ======== END OUTLOOK/TEAMS INTEGRATION ========

        // Initialize
        async function init() {
            // Get opportunity ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            opportunityId = urlParams.get('id');

            if (!opportunityId) {
                document.getElementById('loadingState').innerHTML = '<p style="color: var(--danger-red);">No opportunity ID provided</p>';
                return;
            }

            const authenticated = await checkAuth();
            if (authenticated) {
                await loadOpportunity();
            }
        }

        init();
    </script>
</body>
</html>
