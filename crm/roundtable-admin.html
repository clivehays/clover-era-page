<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundtable Admin - Clover ERA CRM</title>
    <style>
        :root {
            --teal: #46AEB8;
            --deep-teal: #0D7C88;
            --charcoal: #1F2937;
            --white: #FFFFFF;
            --light-gray: #F8F9FA;
            --medium-gray: #E5E7EB;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --success-green: #10B981;
            --warning-yellow: #F59E0B;
            --error-red: #DC2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-gray);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--deep-teal), var(--teal));
            color: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header nav {
            margin-top: 1rem;
        }

        .header nav a {
            color: var(--white);
            text-decoration: none;
            margin-right: 1.5rem;
            opacity: 0.9;
        }

        .header nav a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--deep-teal);
            border-bottom-color: var(--deep-teal);
        }

        .tab:hover {
            color: var(--teal);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-teal);
        }

        .filters {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .table-container {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--light-gray);
        }

        th {
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--medium-gray);
        }

        td {
            padding: 1rem;
            border-top: 1px solid var(--medium-gray);
        }

        tbody tr:hover {
            background: var(--light-gray);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-accepted {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-waitlisted {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-declined {
            background: #FEE2E2;
            color: #991B1B;
        }

        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .score-high {
            background: #D1FAE5;
            color: #065F46;
        }

        .score-medium {
            background: #FEF3C7;
            color: #92400E;
        }

        .score-low {
            background: #FEE2E2;
            color: #991B1B;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: opacity 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--deep-teal);
            color: var(--white);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-small {
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
            margin: 0.25rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--charcoal);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--error-red);
        }

        .detail-section {
            margin: 1.5rem 0;
        }

        .detail-section h3 {
            font-size: 1.1rem;
            color: var(--deep-teal);
            margin-bottom: 0.75rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            margin: 0.75rem 0;
            padding: 0.5rem 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .detail-value {
            color: var(--text-primary);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--medium-gray);
        }

        .notes-area {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="header">
    <h1>Roundtable Admin</h1>
    <nav>
        <a href="index.html">CRM Dashboard</a>
        <a href="roundtable-admin.html">Roundtable</a>
        <a href="kanban.html">Pipeline</a>
        <a href="../roundtable/index.html" target="_blank">View Landing Page</a>
    </nav>
</div>

<div class="container">
    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Applications</h3>
            <div class="value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
            <h3>Pending Review</h3>
            <div class="value" id="statPending">0</div>
        </div>
        <div class="stat-card">
            <h3>Accepted</h3>
            <div class="value" id="statAccepted">0</div>
        </div>
        <div class="stat-card">
            <h3>Avg Score</h3>
            <div class="value" id="statAvgScore">0</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('applications')">Applications</button>
        <button class="tab" onclick="switchTab('cohorts')">Cohorts</button>
    </div>

    <!-- Applications Tab -->
    <div id="applicationsTab" class="tab-content active">
        <!-- Filters -->
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="filterApplications()">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="accepted">Accepted</option>
                        <option value="waitlisted">Waitlisted</option>
                        <option value="declined">Declined</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Company Size</label>
                    <select id="filterSize" onchange="filterApplications()">
                        <option value="">All</option>
                        <option value="200-500">200-500</option>
                        <option value="100-200">100-200</option>
                        <option value="500+">500+</option>
                        <option value="50-100">50-100</option>
                        <option value="Under 50">Under 50</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Score</label>
                    <select id="filterScore" onchange="filterApplications()">
                        <option value="0">All</option>
                        <option value="60">60+ (High)</option>
                        <option value="40">40+ (Medium)</option>
                        <option value="20">20+ (Low)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="filterSearch" placeholder="Name or company..." oninput="filterApplications()">
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('full_name')">Name</th>
                        <th onclick="sortTable('company_name')">Company</th>
                        <th onclick="sortTable('company_size')">Size</th>
                        <th onclick="sortTable('industry')">Industry</th>
                        <th onclick="sortTable('score')">Score</th>
                        <th onclick="sortTable('status')">Status</th>
                        <th onclick="sortTable('created_at')">Applied</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="applicationsTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div>Loading applications...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cohorts Tab -->
    <div id="cohortsTab" class="tab-content">
        <button class="btn btn-primary" onclick="showCreateCohort()" style="margin-bottom: 1.5rem;">Create New Cohort</button>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Spots</th>
                        <th>Accepted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cohortsTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div>Loading cohorts...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Application Detail Modal -->
<div id="applicationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Application Details</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <div id="applicationDetails"></div>

        <div class="action-buttons">
            <button class="btn btn-success" onclick="updateStatus('accepted')">Accept</button>
            <button class="btn btn-primary" onclick="updateStatus('waitlisted')">Waitlist</button>
            <button class="btn btn-danger" onclick="updateStatus('declined')">Decline</button>
        </div>
    </div>
</div>

<script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://dvvsphsvcpxkplumutyc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2dnNwaHN2Y3B4a3BsdW11dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDc3MzksImV4cCI6MjA3OTU4MzczOX0.waQs1wvf4Er66Oe-NI5Ht0M-tHJk83St1UR8AT2dOeI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let applications = [];
    let cohorts = [];
    let currentApplication = null;
    let sortColumn = 'created_at';
    let sortDirection = 'desc';

    // Tab switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');

        if (tabName === 'cohorts') {
            loadCohorts();
        }
    }

    // Load applications
    async function loadApplications() {
        try {
            const { data, error } = await supabase
                .from('roundtable_applications')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            applications = data || [];
            updateStats();
            filterApplications();
        } catch (error) {
            console.error('Error loading applications:', error);
        }
    }

    // Update stats
    function updateStats() {
        const total = applications.length;
        const pending = applications.filter(a => a.status === 'pending').length;
        const accepted = applications.filter(a => a.status === 'accepted').length;
        const avgScore = total > 0
            ? Math.round(applications.reduce((sum, a) => sum + a.score, 0) / total)
            : 0;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPending').textContent = pending;
        document.getElementById('statAccepted').textContent = accepted;
        document.getElementById('statAvgScore').textContent = avgScore;
    }

    // Filter applications
    function filterApplications() {
        const statusFilter = document.getElementById('filterStatus').value;
        const sizeFilter = document.getElementById('filterSize').value;
        const scoreFilter = parseInt(document.getElementById('filterScore').value);
        const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

        let filtered = applications.filter(app => {
            if (statusFilter && app.status !== statusFilter) return false;
            if (sizeFilter && app.company_size !== sizeFilter) return false;
            if (scoreFilter && app.score < scoreFilter) return false;
            if (searchFilter) {
                const searchString = `${app.full_name} ${app.company_name}`.toLowerCase();
                if (!searchString.includes(searchFilter)) return false;
            }
            return true;
        });

        renderApplicationsTable(filtered);
    }

    // Render applications table
    function renderApplicationsTable(apps) {
        const tbody = document.getElementById('applicationsTableBody');

        if (apps.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div>No applications found</div></td></tr>';
            return;
        }

        tbody.innerHTML = apps.map(app => `
            <tr>
                <td>${app.full_name}</td>
                <td>${app.company_name}</td>
                <td>${app.company_size}</td>
                <td>${app.industry}</td>
                <td><span class="score-badge ${getScoreClass(app.score)}">${app.score}</span></td>
                <td><span class="status-badge status-${app.status}">${app.status}</span></td>
                <td>${new Date(app.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="viewApplication('${app.id}')">View</button>
                    <a href="${app.linkedin_url}" target="_blank" class="btn btn-primary btn-small">LinkedIn</a>
                </td>
            </tr>
        `).join('');
    }

    function getScoreClass(score) {
        if (score >= 60) return 'score-high';
        if (score >= 40) return 'score-medium';
        return 'score-low';
    }

    // View application details
    async function viewApplication(id) {
        currentApplication = applications.find(a => a.id === id);
        if (!currentApplication) return;

        const details = `
            <div class="detail-section">
                <h3>Basic Information</h3>
                <div class="detail-row">
                    <div class="detail-label">Name:</div>
                    <div class="detail-value">${currentApplication.full_name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email:</div>
                    <div class="detail-value"><a href="mailto:${currentApplication.email}">${currentApplication.email}</a></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">LinkedIn:</div>
                    <div class="detail-value"><a href="${currentApplication.linkedin_url}" target="_blank">View Profile</a></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Company:</div>
                    <div class="detail-value">${currentApplication.company_name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Title:</div>
                    <div class="detail-value">${currentApplication.title}</div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Qualification</h3>
                <div class="detail-row">
                    <div class="detail-label">Direct Reports:</div>
                    <div class="detail-value">${currentApplication.direct_reports}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Company Size:</div>
                    <div class="detail-value">${currentApplication.company_size}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Industry:</div>
                    <div class="detail-value">${currentApplication.industry}${currentApplication.industry_other ? ': ' + currentApplication.industry_other : ''}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Score:</div>
                    <div class="detail-value"><span class="score-badge ${getScoreClass(currentApplication.score)}">${currentApplication.score}</span></div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Retention Challenges</h3>
                <div class="detail-row">
                    <div class="detail-label">Resignations (12mo):</div>
                    <div class="detail-value">${currentApplication.resignations_12mo}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Surprise Departures:</div>
                    <div class="detail-value">${currentApplication.surprise_departures}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Escalation Experience:</div>
                    <div class="detail-value">${currentApplication.escalation_experience.join('; ')}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Current Challenge:</div>
                    <div class="detail-value">${currentApplication.current_challenge}</div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Intent & Source</h3>
                <div class="detail-row">
                    <div class="detail-label">CEO Intro Openness:</div>
                    <div class="detail-value">${currentApplication.ceo_intro_openness}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Referral Source:</div>
                    <div class="detail-value">${currentApplication.referral_source}${currentApplication.referral_source_other ? ': ' + currentApplication.referral_source_other : ''}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Available for Date:</div>
                    <div class="detail-value">${currentApplication.available_for_date ? 'Yes' : 'No'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Admin Notes</h3>
                <textarea class="notes-area" id="applicationNotes" placeholder="Add notes about this application...">${currentApplication.notes || ''}</textarea>
            </div>
        `;

        document.getElementById('applicationDetails').innerHTML = details;
        document.getElementById('applicationModal').classList.add('show');
    }

    // Update application status
    async function updateStatus(newStatus) {
        if (!currentApplication) return;

        try {
            const notes = document.getElementById('applicationNotes').value;

            const { error } = await supabase
                .from('roundtable_applications')
                .update({
                    status: newStatus,
                    notes: notes
                })
                .eq('id', currentApplication.id);

            if (error) throw error;

            alert(`Application ${newStatus}!`);
            closeModal();
            loadApplications();
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Error updating application status');
        }
    }

    // Close modal
    function closeModal() {
        document.getElementById('applicationModal').classList.remove('show');
        currentApplication = null;
    }

    // Load cohorts
    async function loadCohorts() {
        try {
            const { data, error } = await supabase
                .from('roundtable_cohorts')
                .select('*')
                .order('date', { ascending: false });

            if (error) throw error;

            cohorts = data || [];
            renderCohortsTable();
        } catch (error) {
            console.error('Error loading cohorts:', error);
        }
    }

    // Render cohorts table
    function renderCohortsTable() {
        const tbody = document.getElementById('cohortsTableBody');

        if (cohorts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div>No cohorts found</div></td></tr>';
            return;
        }

        tbody.innerHTML = cohorts.map(cohort => {
            const acceptedCount = applications.filter(a =>
                a.cohort_id === cohort.id && a.status === 'accepted'
            ).length;

            return `
                <tr>
                    <td>${new Date(cohort.date).toLocaleDateString()}</td>
                    <td>${cohort.time} ${cohort.timezone}</td>
                    <td><span class="status-badge status-${cohort.status}">${cohort.status}</span></td>
                    <td>${cohort.max_attendees}</td>
                    <td>${acceptedCount}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editCohort('${cohort.id}')">Edit</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Placeholder functions
    function showCreateCohort() {
        alert('Create cohort functionality - integrate with a form or modal');
    }

    function editCohort(id) {
        alert('Edit cohort functionality - integrate with a form or modal');
    }

    function sortTable(column) {
        // Implement sorting logic
        console.log('Sort by:', column);
    }

    // Initialize
    loadApplications();
</script>

</body>
</html>
