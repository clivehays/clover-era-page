<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Management | Clover ERA CRM</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <style>
        :root {
            --primary-teal: #1ba098;
            --deep-teal: #158f87;
            --soft-beige: #f9f7f4;
            --warm-cream: #fdfbf7;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --success-green: #48bb78;
            --warning-orange: #ed8936;
            --error-red: #f56565;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--warm-cream);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 2px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-teal);
        }

        .header-right {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-teal);
            color: white;
        }

        .btn-primary:hover {
            background: var(--deep-teal);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 160, 152, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-teal);
            color: var(--primary-teal);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-teal);
        }

        .stat-card .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: var(--success-green);
        }

        .stat-change.negative {
            color: var(--error-red);
        }

        /* Filters */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Articles Table */
        .articles-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            color: var(--primary-teal);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--soft-beige);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background: var(--warm-cream);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-draft {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-published {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-pending_review {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-scheduled {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-archived {
            background: #fed7d7;
            color: #742a2a;
        }

        .article-title-cell {
            font-weight: 600;
            color: var(--text-primary);
        }

        .article-title-cell a {
            color: inherit;
            text-decoration: none;
        }

        .article-title-cell a:hover {
            color: var(--primary-teal);
        }

        .category-badge {
            background: var(--soft-beige);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .page-btn:hover {
            border-color: var(--primary-teal);
            color: var(--primary-teal);
        }

        .page-btn.active {
            background: var(--primary-teal);
            color: white;
            border-color: var(--primary-teal);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>üìù Blog Management</h1>
        </div>
        <div class="header-right">
            <a href="/blog-index.html" target="_blank" class="btn btn-secondary">
                üåê View Blog
            </a>
            <a href="/backoffice/blog/editor" class="btn btn-primary">
                ‚úèÔ∏è New Article
            </a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-label">Total Articles</div>
                <div class="stat-value" id="totalArticles">0</div>
                <div class="stat-change positive">+0 this month</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Published</div>
                <div class="stat-value" id="publishedArticles">0</div>
                <div class="stat-change">0% of total</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üëÅÔ∏è</div>
                <div class="stat-label">Total Views (30d)</div>
                <div class="stat-value" id="totalViews">0</div>
                <div class="stat-change positive">+0% vs last month</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ü§ñ</div>
                <div class="stat-label">AI Traffic (30d)</div>
                <div class="stat-value" id="aiTraffic">0</div>
                <div class="stat-change">0% of total views</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Status:</label>
                <select id="statusFilter" onchange="filterArticles()">
                    <option value="all">All</option>
                    <option value="draft">Draft</option>
                    <option value="pending_review">Pending Review</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="published">Published</option>
                    <option value="archived">Archived</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Category:</label>
                <select id="categoryFilter" onchange="filterArticles()">
                    <option value="all">All Categories</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="searchInput" placeholder="Search articles..." oninput="searchArticles()">
            </div>
        </div>

        <!-- Articles Table -->
        <div class="articles-table">
            <div class="table-header">
                <h2>Articles</h2>
                <div>
                    <span id="articleCount">0 articles</span>
                </div>
            </div>

            <div id="tableContainer">
                <div class="empty-state">
                    <h2>Loading articles...</h2>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <!-- Pagination populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api/blog';
        let allArticles = [];
        let filteredArticles = [];
        let currentPage = 1;
        const articlesPerPage = 20;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadArticles();
            await loadStats();
            populateCategoryFilter();
        });

        async function loadArticles() {
            try {
                const response = await fetch(`${API_BASE}/articles?limit=100&sort=updated_at&order=desc`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load articles');

                const data = await response.json();
                allArticles = data.articles;
                filteredArticles = allArticles;

                renderTable();

            } catch (error) {
                console.error('Error loading articles:', error);
                showEmptyState('Error loading articles. Please refresh the page.');
            }
        }

        async function loadStats() {
            try {
                // In production, fetch from dedicated stats endpoint
                // For now, calculate from articles
                const total = allArticles.length;
                const published = allArticles.filter(a => a.status === 'published').length;

                document.getElementById('totalArticles').textContent = total;
                document.getElementById('publishedArticles').textContent = published;

                // TODO: Fetch actual view stats from analytics API
                document.getElementById('totalViews').textContent = '0';
                document.getElementById('aiTraffic').textContent = '0';

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function populateCategoryFilter() {
            const categories = [...new Set(allArticles.map(a => a.category).filter(c => c))];
            const select = document.getElementById('categoryFilter');

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        function filterArticles() {
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredArticles = allArticles.filter(article => {
                const matchesStatus = statusFilter === 'all' || article.status === statusFilter;
                const matchesCategory = categoryFilter === 'all' || article.category === categoryFilter;
                return matchesStatus && matchesCategory;
            });

            currentPage = 1;
            renderTable();
        }

        function searchArticles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (!searchTerm) {
                filterArticles();
                return;
            }

            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredArticles = allArticles.filter(article => {
                const matchesSearch = article.title.toLowerCase().includes(searchTerm) ||
                                    (article.excerpt && article.excerpt.toLowerCase().includes(searchTerm));
                const matchesStatus = statusFilter === 'all' || article.status === statusFilter;
                const matchesCategory = categoryFilter === 'all' || article.category === categoryFilter;

                return matchesSearch && matchesStatus && matchesCategory;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');
            const articleCount = document.getElementById('articleCount');

            if (filteredArticles.length === 0) {
                showEmptyState('No articles found');
                return;
            }

            articleCount.textContent = `${filteredArticles.length} article${filteredArticles.length !== 1 ? 's' : ''}`;

            // Pagination
            const startIndex = (currentPage - 1) * articlesPerPage;
            const endIndex = startIndex + articlesPerPage;
            const paginatedArticles = filteredArticles.slice(startIndex, endIndex);

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Views</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedArticles.map(article => `
                            <tr>
                                <td class="article-title-cell">
                                    <a href="/backoffice/blog/editor?id=${article.id}">${article.title}</a>
                                </td>
                                <td>
                                    ${article.category ? `<span class="category-badge">${article.category}</span>` : '-'}
                                </td>
                                <td>
                                    <span class="status-badge status-${article.status}">${article.status.replace('_', ' ')}</span>
                                </td>
                                <td>${article.view_count || 0}</td>
                                <td>${formatDate(article.updated_at)}</td>
                                <td>
                                    <div class="actions">
                                        <button class="action-btn" onclick="editArticle('${article.id}')" title="Edit">
                                            ‚úèÔ∏è
                                        </button>
                                        ${article.status === 'published' ?
                                            `<button class="action-btn" onclick="viewArticle('${article.slug}')" title="View">
                                                üëÅÔ∏è
                                            </button>` : ''
                                        }
                                        <button class="action-btn" onclick="viewAnalytics('${article.id}')" title="Analytics">
                                            üìä
                                        </button>
                                        <button class="action-btn" onclick="deleteArticle('${article.id}')" title="Delete">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
            const paginationContainer = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';

            let paginationHTML = `
                <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            paginationHTML += `
                <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;

            paginationContainer.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);

            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderTable();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function editArticle(id) {
            window.location.href = `/backoffice/blog/editor?id=${id}`;
        }

        function viewArticle(slug) {
            window.open(`/blog/${slug}.html`, '_blank');
        }

        function viewAnalytics(id) {
            window.location.href = `/backoffice/blog/analytics?id=${id}`;
        }

        async function deleteArticle(id) {
            const confirmed = confirm('Are you sure you want to delete this article? This action cannot be undone.');

            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/articles/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete article');

                alert('Article deleted successfully');
                await loadArticles();

            } catch (error) {
                console.error('Error deleting article:', error);
                alert('Error deleting article');
            }
        }

        function showEmptyState(message) {
            const container = document.getElementById('tableContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <h2>${message}</h2>
                    <p>Try adjusting your filters or create a new article</p>
                </div>
            `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function getAuthToken() {
            // TODO: Implement proper JWT token retrieval
            return localStorage.getItem('authToken') || '';
        }
    </script>
</body>
</html>
